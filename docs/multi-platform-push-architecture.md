# å¤šå¹³å°æ¨é€æ¶æ„è®¾è®¡ï¼ˆAndroid + iOSï¼‰

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°å¦‚ä½•æ‰©å±•ç°æœ‰æ¨é€æ–¹æ¡ˆï¼ŒåŒæ—¶æ”¯æŒAndroidå’ŒiOSå¹³å°ï¼Œå®ç°ç»Ÿä¸€çš„æ¨é€æœåŠ¡æ¶æ„ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€æ¨é€æ¥å£**ï¼šåç«¯æä¾›ç»Ÿä¸€çš„æ¨é€APIï¼Œæ”¯æŒå¤šå¹³å°
2. **å¹³å°é€æ˜**ï¼šä¸šåŠ¡å±‚æ— éœ€å…³å¿ƒå…·ä½“å¹³å°å®ç°
3. **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒå¹³å°é™çº§å’Œå®¹é”™
4. **æ˜“äºæ‰©å±•**ï¼šæœªæ¥å¯è½»æ¾æ·»åŠ æ–°å¹³å°ï¼ˆå¦‚Webã€å°ç¨‹åºç­‰ï¼‰

## ğŸ—ï¸ ç»Ÿä¸€æ¨é€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»Ÿä¸€æ¨é€æœåŠ¡æ¶æ„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚ (Business Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ¨é€ä¸šåŠ¡é€»è¾‘                                         â”‚   â”‚
â”‚  â”‚  - æ¶ˆæ¯å†…å®¹ç”Ÿæˆ                                       â”‚   â”‚
â”‚  â”‚  - æ¨é€ç­–ç•¥å†³ç­–                                       â”‚   â”‚
â”‚  â”‚  - ç”¨æˆ·åˆ†ç»„ç®¡ç†                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»Ÿä¸€æ¨é€æœåŠ¡å±‚ (Unified Push Service)             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ¨é€æœåŠ¡æ¥å£ (PushService)                           â”‚   â”‚
â”‚  â”‚  - sendToUser(userId, message)                       â”‚   â”‚
â”‚  â”‚  - sendToUsers(userIds, message)                     â”‚   â”‚
â”‚  â”‚  - sendToTag(tag, message)                           â”‚   â”‚
â”‚  â”‚  - sendBroadcast(message)                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                    â”‚
â”‚                          â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å¹³å°é€‚é…å±‚ (Platform Adapter Layer)                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚  â”‚ Androidé€‚é…å™¨ â”‚  â”‚  iOSé€‚é…å™¨    â”‚                â”‚   â”‚
â”‚  â”‚  â”‚ - FCM/JPush   â”‚  â”‚ - APNs       â”‚                â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Androidæ¨é€ â”‚              â”‚   iOSæ¨é€     â”‚
â”‚  FCM/JPush   â”‚              â”‚   APNs       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“± iOSæ¨é€ç‰¹æ®Šæ€§

### 1. Apple Push Notification Service (APNs)

**ç‰¹ç‚¹**ï¼š
- **ç³»ç»Ÿçº§æœåŠ¡**ï¼šiOSç³»ç»Ÿæä¾›çš„æ¨é€æœåŠ¡
- **å¿…é¡»ä½¿ç”¨APNs**ï¼šæ— æ³•ç»•è¿‡ï¼Œæ‰€æœ‰æ¨é€å¿…é¡»é€šè¿‡APNs
- **è¯ä¹¦/å¯†é’¥è®¤è¯**ï¼šéœ€è¦é…ç½®APNsè¯ä¹¦æˆ–å¯†é’¥
- **ç”Ÿäº§/å¼€å‘ç¯å¢ƒ**ï¼šåŒºåˆ†å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ

**æ¶æ„**ï¼š
```
åº”ç”¨æœåŠ¡å™¨
    â†“
APNsæœåŠ¡å™¨ (Apple)
    â†“
iOSè®¾å¤‡
```

### 2. ä¸Androidçš„å·®å¼‚

| ç‰¹æ€§ | Android | iOS |
|------|---------|-----|
| **æ¨é€æœåŠ¡** | FCM/JPush/å‚å•†æ¨é€ | ä»…APNs |
| **Tokenè·å–** | åº”ç”¨å†…è·å– | ç³»ç»Ÿå›è°ƒè·å– |
| **Tokenæ ¼å¼** | å­—ç¬¦ä¸² | å­—ç¬¦ä¸²ï¼ˆDevice Tokenï¼‰ |
| **æ¶ˆæ¯æ ¼å¼** | JSON | JSONï¼ˆAPNsæ ¼å¼ï¼‰ |
| **æ¨é€é™åˆ¶** | æ— ç‰¹æ®Šé™åˆ¶ | æœ‰æ¨é€é¢‘ç‡é™åˆ¶ |
| **é™é»˜æ¨é€** | æ”¯æŒ | æ”¯æŒï¼ˆBackgroundï¼‰ |
| **é€šçŸ¥æ˜¾ç¤º** | å¯è‡ªå®šä¹‰ | ç³»ç»Ÿç»Ÿä¸€ç®¡ç† |

## ğŸ”§ æ¶æ„æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šç»Ÿä¸€æ¨é€æœåŠ¡å±‚ï¼ˆæ¨èï¼‰â­

#### æ¶æ„è®¾è®¡

```java
// 1. å®šä¹‰ç»Ÿä¸€çš„æ¶ˆæ¯æ¨¡å‹
public class PushMessage {
    private String title;
    private String body;
    private Map<String, String> data;
    private PushPriority priority;
    private PushPlatform platform; // ANDROID, IOS, ALL
    private String sound;
    private String badge; // iOSä¸“ç”¨
    private String category; // iOSä¸“ç”¨
    private Map<String, Object> customData;
}

// 2. å®šä¹‰æ¨é€ç»“æœæ¨¡å‹
public class PushResult {
    private boolean success;
    private String messageId;
    private String error;
    private PushPlatform platform;
    private Integer successCount;
    private Integer failureCount;
}

// 3. ç»Ÿä¸€æ¨é€æœåŠ¡æ¥å£
public interface UnifiedPushService {
    /**
     * æ¨é€ç»™å•ä¸ªç”¨æˆ·
     */
    PushResult sendToUser(String userId, PushMessage message);
    
    /**
     * æ‰¹é‡æ¨é€
     */
    PushResult sendToUsers(List<String> userIds, PushMessage message);
    
    /**
     * æŒ‰æ ‡ç­¾æ¨é€
     */
    PushResult sendToTag(String tag, PushMessage message);
    
    /**
     * å¹¿æ’­æ¨é€
     */
    PushResult broadcast(PushMessage message);
}
```

#### å¹³å°é€‚é…å™¨å®ç°

```java
// Androidæ¨é€é€‚é…å™¨
@Service
public class AndroidPushAdapter implements PushAdapter {
    @Autowired
    private PushNotificationService fcmService; // FCMæœåŠ¡
    @Autowired
    private JPushService jpushService; // æå…‰æ¨é€æœåŠ¡
    
    @Override
    public PushResult send(String token, PushMessage message) {
        // æ ¹æ®é…ç½®é€‰æ‹©æ¨é€æœåŠ¡
        if (useJPush()) {
            return jpushService.send(token, convertToJPushMessage(message));
        } else {
            return fcmService.sendToDevice(token, message.getTitle(), 
                message.getBody(), message.getData(), "high");
        }
    }
    
    @Override
    public PushPlatform getPlatform() {
        return PushPlatform.ANDROID;
    }
}

// iOSæ¨é€é€‚é…å™¨
@Service
public class IOSPushAdapter implements PushAdapter {
    @Autowired
    private APNsService apnsService;
    
    @Override
    public PushResult send(String token, PushMessage message) {
        APNsMessage apnsMessage = convertToAPNsMessage(message);
        return apnsService.send(token, apnsMessage);
    }
    
    @Override
    public PushPlatform getPlatform() {
        return PushPlatform.IOS;
    }
    
    private APNsMessage convertToAPNsMessage(PushMessage message) {
        APNsMessage apns = new APNsMessage();
        apns.setAlert(new Alert(message.getTitle(), message.getBody()));
        apns.setSound(message.getSound() != null ? message.getSound() : "default");
        apns.setBadge(message.getBadge());
        apns.setCategory(message.getCategory());
        apns.setCustomData(message.getCustomData());
        return apns;
    }
}
```

#### ç»Ÿä¸€æ¨é€æœåŠ¡å®ç°

```java
@Service
public class UnifiedPushServiceImpl implements UnifiedPushService {
    
    @Autowired
    private List<PushAdapter> pushAdapters;
    
    @Autowired
    private UserDeviceService userDeviceService;
    
    private Map<PushPlatform, PushAdapter> adapterMap;
    
    @PostConstruct
    public void init() {
        adapterMap = pushAdapters.stream()
            .collect(Collectors.toMap(
                PushAdapter::getPlatform,
                adapter -> adapter
            ));
    }
    
    @Override
    public PushResult sendToUser(String userId, PushMessage message) {
        // 1. è·å–ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡
        List<DeviceInfo> devices = userDeviceService.getUserDevices(userId);
        
        if (devices.isEmpty()) {
            return PushResult.failure("ç”¨æˆ·æ— åœ¨çº¿è®¾å¤‡");
        }
        
        // 2. æŒ‰å¹³å°åˆ†ç»„
        Map<PushPlatform, List<DeviceInfo>> devicesByPlatform = 
            devices.stream().collect(Collectors.groupingBy(DeviceInfo::getPlatform));
        
        // 3. åˆ†åˆ«æ¨é€åˆ°å„å¹³å°
        List<PushResult> results = new ArrayList<>();
        for (Map.Entry<PushPlatform, List<DeviceInfo>> entry : devicesByPlatform.entrySet()) {
            PushPlatform platform = entry.getKey();
            List<DeviceInfo> platformDevices = entry.getValue();
            
            PushAdapter adapter = adapterMap.get(platform);
            if (adapter == null) {
                continue;
            }
            
            // é€‚é…å¹³å°ç‰¹å®šçš„æ¶ˆæ¯æ ¼å¼
            PushMessage platformMessage = adaptMessageForPlatform(message, platform);
            
            // æ‰¹é‡æ¨é€
            for (DeviceInfo device : platformDevices) {
                PushResult result = adapter.send(device.getToken(), platformMessage);
                results.add(result);
            }
        }
        
        // 4. åˆå¹¶ç»“æœ
        return mergeResults(results);
    }
    
    @Override
    public PushResult sendToUsers(List<String> userIds, PushMessage message) {
        // æ‰¹é‡æ¨é€å®ç°
        List<PushResult> results = userIds.stream()
            .map(userId -> sendToUser(userId, message))
            .collect(Collectors.toList());
        
        return mergeResults(results);
    }
    
    private PushMessage adaptMessageForPlatform(PushMessage message, PushPlatform platform) {
        PushMessage adapted = new PushMessage();
        adapted.setTitle(message.getTitle());
        adapted.setBody(message.getBody());
        adapted.setData(message.getData());
        adapted.setPriority(message.getPriority());
        adapted.setPlatform(platform);
        
        // iOSç‰¹å®šå­—æ®µ
        if (platform == PushPlatform.IOS) {
            adapted.setSound(message.getSound() != null ? message.getSound() : "default");
            adapted.setBadge(message.getBadge());
            adapted.setCategory(message.getCategory());
        }
        
        // Androidç‰¹å®šå­—æ®µ
        if (platform == PushPlatform.ANDROID) {
            // Androidç‰¹å®šé…ç½®
        }
        
        return adapted;
    }
}
```

### æ–¹æ¡ˆäºŒï¼šè®¾å¤‡ä¿¡æ¯ç®¡ç†

#### è®¾å¤‡ä¿¡æ¯æ¨¡å‹

```java
@Entity
@Table(name = "user_devices")
public class UserDevice {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String userId;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PushPlatform platform; // ANDROID, IOS
    
    @Column(nullable = false)
    private String deviceToken; // FCM Token / APNs Device Token
    
    @Column
    private String deviceId; // è®¾å¤‡å”¯ä¸€æ ‡è¯†
    
    @Column
    private String deviceModel; // è®¾å¤‡å‹å·
    
    @Column
    private String appVersion; // åº”ç”¨ç‰ˆæœ¬
    
    @Column
    private String osVersion; // ç³»ç»Ÿç‰ˆæœ¬
    
    @Column
    private Boolean isActive; // æ˜¯å¦æ´»è·ƒ
    
    @Column
    private LocalDateTime lastActiveTime; // æœ€åæ´»è·ƒæ—¶é—´
    
    @Column
    private LocalDateTime createdAt;
    
    @Column
    private LocalDateTime updatedAt;
}

public enum PushPlatform {
    ANDROID,
    IOS,
    WEB
}
```

#### è®¾å¤‡æœåŠ¡å®ç°

```java
@Service
public class UserDeviceService {
    
    @Autowired
    private UserDeviceRepository deviceRepository;
    
    /**
     * æ³¨å†Œè®¾å¤‡Token
     */
    public void registerDevice(String userId, DeviceRegisterRequest request) {
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å­˜åœ¨
        UserDevice device = deviceRepository.findByUserIdAndDeviceId(
            userId, request.getDeviceId()
        ).orElse(new UserDevice());
        
        device.setUserId(userId);
        device.setPlatform(request.getPlatform());
        device.setDeviceToken(request.getToken());
        device.setDeviceId(request.getDeviceId());
        device.setDeviceModel(request.getDeviceModel());
        device.setAppVersion(request.getAppVersion());
        device.setOsVersion(request.getOsVersion());
        device.setIsActive(true);
        device.setLastActiveTime(LocalDateTime.now());
        
        if (device.getId() == null) {
            device.setCreatedAt(LocalDateTime.now());
        }
        device.setUpdatedAt(LocalDateTime.now());
        
        deviceRepository.save(device);
    }
    
    /**
     * è·å–ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡
     */
    public List<DeviceInfo> getUserDevices(String userId) {
        return deviceRepository.findByUserIdAndIsActiveTrue(userId)
            .stream()
            .map(this::toDeviceInfo)
            .collect(Collectors.toList());
    }
    
    /**
     * è·å–ç”¨æˆ·æŒ‡å®šå¹³å°çš„è®¾å¤‡
     */
    public List<DeviceInfo> getUserDevicesByPlatform(String userId, PushPlatform platform) {
        return deviceRepository.findByUserIdAndPlatformAndIsActiveTrue(userId, platform)
            .stream()
            .map(this::toDeviceInfo)
            .collect(Collectors.toList());
    }
    
    /**
     * æ›´æ–°è®¾å¤‡æ´»è·ƒçŠ¶æ€
     */
    public void updateDeviceActive(String userId, String deviceId) {
        deviceRepository.findByUserIdAndDeviceId(userId, deviceId)
            .ifPresent(device -> {
                device.setIsActive(true);
                device.setLastActiveTime(LocalDateTime.now());
                deviceRepository.save(device);
            });
    }
    
    /**
     * åˆ é™¤è®¾å¤‡ï¼ˆç”¨æˆ·é€€å‡ºç™»å½•æˆ–å¸è½½åº”ç”¨ï¼‰
     */
    public void removeDevice(String userId, String deviceId) {
        deviceRepository.findByUserIdAndDeviceId(userId, deviceId)
            .ifPresent(device -> {
                device.setIsActive(false);
                deviceRepository.save(device);
            });
    }
}
```

### æ–¹æ¡ˆä¸‰ï¼šAPNsæœåŠ¡å®ç°

#### APNsé…ç½®

```java
@Configuration
public class APNsConfig {
    
    @Value("${apns.key-id}")
    private String keyId;
    
    @Value("${apns.team-id}")
    private String teamId;
    
    @Value("${apns.bundle-id}")
    private String bundleId;
    
    @Value("${apns.key-path}")
    private String keyPath;
    
    @Value("${apns.production:true}")
    private boolean production;
    
    @Bean
    public ApnsClient apnsClient() throws Exception {
        // ä½¿ç”¨APNs Auth Keyï¼ˆæ¨èæ–¹å¼ï¼‰
        File keyFile = new File(keyPath);
        String authKey = Files.readString(keyFile.toPath());
        
        ApnsClientBuilder builder = new ApnsClientBuilder()
            .setApnsServer(production ? 
                ApnsClientBuilder.PRODUCTION_APNS_HOST : 
                ApnsClientBuilder.DEVELOPMENT_APNS_HOST)
            .setSigningKey(ApnsSigningKey.loadFromP8String(authKey, teamId, keyId))
            .setConcurrentConnections(10)
            .setConnectionTimeout(Duration.ofSeconds(10));
        
        return builder.build();
    }
}
```

#### APNsæœåŠ¡å®ç°

```java
@Service
public class APNsService {
    
    @Autowired
    private ApnsClient apnsClient;
    
    @Value("${apns.bundle-id}")
    private String bundleId;
    
    /**
     * å‘é€æ¨é€æ¶ˆæ¯
     */
    public PushResult send(String deviceToken, APNsMessage message) {
        try {
            // æ„å»ºAPNsæ¨é€è¯·æ±‚
            SimpleApnsPushNotification notification = new SimpleApnsPushNotification(
                deviceToken,
                bundleId,
                buildPayload(message)
            );
            
            // å‘é€æ¨é€
            Future<PushNotificationResponse<SimpleApnsPushNotification>> future = 
                apnsClient.sendNotification(notification);
            
            PushNotificationResponse<SimpleApnsPushNotification> response = future.get();
            
            if (response.isAccepted()) {
                return PushResult.success(response.getApnsId().toString());
            } else {
                String reason = response.getRejectionReason().orElse("Unknown");
                return PushResult.failure("APNs rejected: " + reason);
            }
            
        } catch (Exception e) {
            logger.error("APNsæ¨é€å¤±è´¥", e);
            return PushResult.failure("APNsæ¨é€å¼‚å¸¸: " + e.getMessage());
        }
    }
    
    /**
     * æ‰¹é‡å‘é€
     */
    public PushResult sendBatch(List<String> deviceTokens, APNsMessage message) {
        int successCount = 0;
        int failureCount = 0;
        
        for (String token : deviceTokens) {
            PushResult result = send(token, message);
            if (result.isSuccess()) {
                successCount++;
            } else {
                failureCount++;
            }
        }
        
        return PushResult.batchResult(successCount, failureCount);
    }
    
    /**
     * æ„å»ºAPNs Payload
     */
    private String buildPayload(APNsMessage message) {
        JSONObject payload = new JSONObject();
        JSONObject aps = new JSONObject();
        
        // Alert
        if (message.getAlert() != null) {
            JSONObject alert = new JSONObject();
            alert.put("title", message.getAlert().getTitle());
            alert.put("body", message.getAlert().getBody());
            aps.put("alert", alert);
        }
        
        // Sound
        if (message.getSound() != null) {
            aps.put("sound", message.getSound());
        }
        
        // Badge
        if (message.getBadge() != null) {
            aps.put("badge", Integer.parseInt(message.getBadge()));
        }
        
        // Category
        if (message.getCategory() != null) {
            aps.put("category", message.getCategory());
        }
        
        // Content Available (é™é»˜æ¨é€)
        if (message.isContentAvailable()) {
            aps.put("content-available", 1);
        }
        
        payload.put("aps", aps);
        
        // è‡ªå®šä¹‰æ•°æ®
        if (message.getCustomData() != null) {
            message.getCustomData().forEach(payload::put);
        }
        
        return payload.toString();
    }
}
```

## ğŸ“± å®¢æˆ·ç«¯å®ç°

### iOSå®¢æˆ·ç«¯

```swift
import UserNotifications
import UIKit

class PushNotificationManager: NSObject {
    static let shared = PushNotificationManager()
    
    func registerForPushNotifications() {
        UNUserNotificationCenter.current().delegate = self
        UNUserNotificationCenter.current().requestAuthorization(
            options: [.alert, .sound, .badge]
        ) { granted, error in
            if granted {
                DispatchQueue.main.async {
                    UIApplication.shared.registerForRemoteNotifications()
                }
            }
        }
    }
    
    func didRegisterForRemoteNotifications(deviceToken: Data) {
        let tokenParts = deviceToken.map { data in String(format: "%02.2hhx", data) }
        let token = tokenParts.joined()
        
        // å‘é€Tokenåˆ°æœåŠ¡å™¨
        sendTokenToServer(token)
    }
    
    func didFailToRegisterForRemoteNotifications(error: Error) {
        print("Failed to register: \(error)")
    }
    
    private func sendTokenToServer(_ token: String) {
        // è°ƒç”¨APIæ³¨å†ŒToken
        let url = URL(string: "https://your-api.com/api/push/register-token")!
        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        
        let body: [String: Any] = [
            "token": token,
            "platform": "IOS",
            "deviceId": UIDevice.current.identifierForVendor?.uuidString ?? "",
            "deviceModel": UIDevice.current.model,
            "osVersion": UIDevice.current.systemVersion,
            "appVersion": Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? ""
        ]
        
        request.httpBody = try? JSONSerialization.data(withJSONObject: body)
        
        URLSession.shared.dataTask(with: request) { data, response, error in
            if let error = error {
                print("Error: \(error)")
            }
        }.resume()
    }
}

// AppDelegateæ‰©å±•
extension AppDelegate: UNUserNotificationCenterDelegate {
    // åº”ç”¨åœ¨å‰å°æ—¶æ”¶åˆ°é€šçŸ¥
    func userNotificationCenter(_ center: UNUserNotificationCenter,
                               willPresent notification: UNNotification,
                               withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
        // æ˜¾ç¤ºé€šçŸ¥
        completionHandler([.alert, .sound, .badge])
    }
    
    // ç”¨æˆ·ç‚¹å‡»é€šçŸ¥
    func userNotificationCenter(_ center: UNUserNotificationCenter,
                               didReceive response: UNNotificationResponse,
                               withCompletionHandler completionHandler: @escaping () -> Void) {
        let userInfo = response.notification.request.content.userInfo
        
        // å¤„ç†é€šçŸ¥ç‚¹å‡»
        handleNotificationClick(userInfo)
        
        completionHandler()
    }
}
```

### Androidå®¢æˆ·ç«¯ï¼ˆæ›´æ–°ï¼‰

```kotlin
// æ›´æ–°FCMTokenManagerä»¥æ”¯æŒå¤šå¹³å°æ ‡è¯†
class FCMTokenManager(private val context: Context) {
    
    fun getToken(callback: (String?) -> Unit) {
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (!task.isSuccessful) {
                callback(null)
                return@addOnCompleteListener
            }
            
            val token = task.result
            saveTokenLocally(token)
            sendTokenToServer(token)
            callback(token)
        }
    }
    
    private fun sendTokenToServer(token: String) {
        val apiService = RetrofitClient.apiService
        val request = TokenRegisterRequest(
            token = token,
            platform = "ANDROID", // æ˜ç¡®æ ‡è¯†å¹³å°
            deviceId = getDeviceId(),
            deviceModel = Build.MODEL,
            osVersion = Build.VERSION.RELEASE,
            appVersion = getAppVersion()
        )
        
        apiService.registerToken(request).enqueue(object : Callback<ResponseBody> {
            override fun onResponse(call: Call<ResponseBody>, response: Response<ResponseBody>) {
                if (response.isSuccessful) {
                    Log.d(TAG, "Tokenæ³¨å†ŒæˆåŠŸ")
                }
            }
            
            override fun onFailure(call: Call<ResponseBody>, t: Throwable) {
                Log.e(TAG, "Tokenæ³¨å†Œå¤±è´¥", t)
            }
        })
    }
}
```

## ğŸ”„ APIæ¥å£è®¾è®¡

### ç»Ÿä¸€æ¨é€API

```java
@RestController
@RequestMapping("/api/push")
public class UnifiedPushController {
    
    @Autowired
    private UnifiedPushService pushService;
    
    /**
     * æ¨é€ç»™å•ä¸ªç”¨æˆ·
     */
    @PostMapping("/send")
    public ResponseEntity<Map<String, Object>> sendPush(
            @RequestParam String userId,
            @Valid @RequestBody PushMessageRequest request) {
        
        PushMessage message = convertToPushMessage(request);
        PushResult result = pushService.sendToUser(userId, message);
        
        return ResponseEntity.ok(createResponse(result));
    }
    
    /**
     * æ‰¹é‡æ¨é€
     */
    @PostMapping("/batch")
    public ResponseEntity<Map<String, Object>> batchPush(
            @Valid @RequestBody BatchPushRequest request) {
        
        PushMessage message = convertToPushMessage(request);
        PushResult result = pushService.sendToUsers(request.getUserIds(), message);
        
        return ResponseEntity.ok(createResponse(result));
    }
    
    /**
     * æŒ‰å¹³å°æ¨é€
     */
    @PostMapping("/send-by-platform")
    public ResponseEntity<Map<String, Object>> sendByPlatform(
            @RequestParam PushPlatform platform,
            @Valid @RequestBody PushMessageRequest request) {
        
        PushMessage message = convertToPushMessage(request);
        message.setPlatform(platform);
        
        // è·å–è¯¥å¹³å°çš„æ‰€æœ‰ç”¨æˆ·
        List<String> userIds = userDeviceService.getUsersByPlatform(platform);
        PushResult result = pushService.sendToUsers(userIds, message);
        
        return ResponseEntity.ok(createResponse(result));
    }
    
    /**
     * æ³¨å†Œè®¾å¤‡Token
     */
    @PostMapping("/register-device")
    public ResponseEntity<Map<String, Object>> registerDevice(
            @Valid @RequestBody DeviceRegisterRequest request) {
        
        String userId = getCurrentUserId(); // ä»è®¤è¯ä¿¡æ¯è·å–
        userDeviceService.registerDevice(userId, request);
        
        return ResponseEntity.ok(createSuccessResponse());
    }
}
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

```sql
-- ç”¨æˆ·è®¾å¤‡è¡¨
CREATE TABLE user_devices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL,
    platform ENUM('ANDROID', 'IOS', 'WEB') NOT NULL,
    device_token VARCHAR(255) NOT NULL,
    device_id VARCHAR(128),
    device_model VARCHAR(128),
    app_version VARCHAR(32),
    os_version VARCHAR(32),
    is_active BOOLEAN DEFAULT TRUE,
    last_active_time DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_platform (platform),
    INDEX idx_device_token (device_token),
    INDEX idx_user_platform (user_id, platform),
    UNIQUE KEY uk_user_device (user_id, device_id)
);

-- æ¨é€è®°å½•è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºç»Ÿè®¡ï¼‰
CREATE TABLE push_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64),
    platform ENUM('ANDROID', 'IOS', 'WEB'),
    device_token VARCHAR(255),
    message_id VARCHAR(128),
    title VARCHAR(255),
    body TEXT,
    status ENUM('SUCCESS', 'FAILED', 'PENDING') DEFAULT 'PENDING',
    error_message TEXT,
    sent_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_platform (platform),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€

```java
// ç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹ï¼Œæ”¯æŒå¤šå¹³å°
public class PushMessage {
    // é€šç”¨å­—æ®µ
    private String title;
    private String body;
    private Map<String, String> data;
    
    // iOSç‰¹å®šå­—æ®µ
    private String sound = "default";
    private String badge;
    private String category;
    private boolean contentAvailable = false; // é™é»˜æ¨é€
    
    // Androidç‰¹å®šå­—æ®µ
    private String channelId = "default_channel";
    private String clickAction;
    private String priority = "high";
}
```

### 2. é”™è¯¯å¤„ç†å’Œé™çº§

```java
public PushResult sendToUser(String userId, PushMessage message) {
    List<DeviceInfo> devices = userDeviceService.getUserDevices(userId);
    
    Map<PushPlatform, List<PushResult>> resultsByPlatform = new HashMap<>();
    
    for (DeviceInfo device : devices) {
        PushAdapter adapter = adapterMap.get(device.getPlatform());
        if (adapter == null) {
            continue;
        }
        
        try {
            PushResult result = adapter.send(device.getToken(), message);
            resultsByPlatform.computeIfAbsent(device.getPlatform(), k -> new ArrayList<>())
                .add(result);
        } catch (Exception e) {
            // è®°å½•é”™è¯¯ï¼Œä½†ä¸ä¸­æ–­å…¶ä»–è®¾å¤‡çš„æ¨é€
            logger.error("æ¨é€å¤±è´¥: userId={}, platform={}", userId, device.getPlatform(), e);
            
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°é™çº§ç­–ç•¥
            // ä¾‹å¦‚ï¼šAPNså¤±è´¥æ—¶ï¼Œå¯ä»¥å°è¯•å…¶ä»–æ–¹å¼
        }
    }
    
    return mergeResults(resultsByPlatform);
}
```

### 3. æ¨é€ç»Ÿè®¡å’Œç›‘æ§

```java
@Service
public class PushStatisticsService {
    
    public void recordPush(String userId, PushPlatform platform, 
                          String messageId, boolean success) {
        PushRecord record = new PushRecord();
        record.setUserId(userId);
        record.setPlatform(platform);
        record.setMessageId(messageId);
        record.setStatus(success ? PushStatus.SUCCESS : PushStatus.FAILED);
        record.setSentAt(LocalDateTime.now());
        
        pushRecordRepository.save(record);
    }
    
    public PushStatistics getStatistics(LocalDate startDate, LocalDate endDate) {
        // ç»Ÿè®¡å„å¹³å°çš„æ¨é€æˆåŠŸç‡
        // ç»Ÿè®¡æ¨é€é‡
        // ç»Ÿè®¡é”™è¯¯ç±»å‹
        return statistics;
    }
}
```

## ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# application.yml
push:
  # Androidé…ç½®
  android:
    enabled: true
    provider: jpush # fcm æˆ– jpush
    fcm:
      service-account-key: serviceAccountKey.json
    jpush:
      app-key: your_jpush_app_key
      master-secret: your_jpush_master_secret
  
  # iOSé…ç½®
  ios:
    enabled: true
    apns:
      key-id: your_apns_key_id
      team-id: your_apns_team_id
      bundle-id: com.yourapp.ios
      key-path: /path/to/AuthKey_XXXXX.p8
      production: true # false for development
```

## âœ… å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µï¼šiOSåŸºç¡€æ”¯æŒ**
   - å®ç°APNsæœåŠ¡
   - æ·»åŠ è®¾å¤‡æ³¨å†ŒAPI
   - iOSå®¢æˆ·ç«¯é›†æˆ

2. **ç¬¬äºŒé˜¶æ®µï¼šç»Ÿä¸€æ¨é€æœåŠ¡**
   - å®ç°ç»Ÿä¸€æ¨é€æ¥å£
   - å®ç°å¹³å°é€‚é…å™¨
   - æ›´æ–°Androidå®¢æˆ·ç«¯

3. **ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œç›‘æ§**
   - æ·»åŠ æ¨é€ç»Ÿè®¡
   - å®ç°é”™è¯¯å¤„ç†å’Œé™çº§
   - æ·»åŠ ç›‘æ§å’Œå‘Šè­¦

## ğŸ“š æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ¶æ„è®¾è®¡ï¼Œå¯ä»¥å®ç°ï¼š

1. âœ… **ç»Ÿä¸€æ¥å£**ï¼šä¸šåŠ¡å±‚ä½¿ç”¨ç»Ÿä¸€APIï¼Œæ— éœ€å…³å¿ƒå¹³å°å·®å¼‚
2. âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢å¹³å°åªéœ€å®ç°é€‚é…å™¨
3. âœ… **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒå¹³å°é™çº§å’Œå®¹é”™
4. âœ… **å®Œæ•´ç›‘æ§**ï¼šæ”¯æŒæ¨é€ç»Ÿè®¡å’Œç›‘æ§

è¿™æ ·çš„æ¶æ„è®¾è®¡æ—¢ä¿æŒäº†çµæ´»æ€§ï¼Œåˆæä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

